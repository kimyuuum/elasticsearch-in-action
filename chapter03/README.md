# 03장 아키텍처

### 개요

Elasticsearch는 다양한 규모의 데이터를 제공하는 컴퓨터 그룹에 이르기까지 무엇이든 실행할 수 있는 서버 측 애플리케이션이다.

자바로 개발된 고성능 풀텍스트 검색 라이브러리인 아파치 루씬은 강력한 검색 및 인덱싱 기능으로 잘 알려져 있다.

Elasticsearch는 단순한 풀텍스트 검색엔진 그 이상이다.

### 3.1.1 데이터 입력

Elasticsearch가 쿼리에 답변을 제공하려면 먼저 데이터가 필요하다.

아래와 같은 방법으로 Elasticsearch로 인덱싱할 수 있다.

- 데이터베이스
- 파일 저장소
- 애플리케이션

Elasticsearch는 데이터가 영구 저장소에서 나오거나 실시간으로 내부적으로 분석되고 처리될 것으로 기대한다. 

### 3.1.2 데이터 처리

Elasticsearch의 기본 정보 단위는 JSON 도큐먼트로 표현된다.

예를 들어 다음 목록과 같이 뉴스 기사를 잡지를 위한 JSON 도큐먼트로 생성할 수 있다.

```json
{
	"title" : "Is Remote Working the New Norm?",
	"author" : "John Doe",
	"number_of_words" : 3500
}
```

데이터 수집

관계형 데이터베이스에 데이터를 저장하는 것처럼 Elasticsearch에도 데이터를 유지해야 한다.

Elasticsearch는 최적화 및 압축 기술을 사용해 모든 데이터를 디스크에 저장한다.

바이너리를 사용해 Elasticsearch를 설치한 경우 설치 폴더 아래에 `data` 라는 폴더가 있다.

- 데이터 폴더는 네트워크 파일시스템으로 마운트되거나, 마운트 경로로 정의되거나, [path.data](http://path.data)  변수로 선언될 수 있다.
- 설치 매커니즘에 관계없이 Elasticsearch는 최적화된 파일시스템에 데이터를 저장한다.

- Elasticsearch는 데이터를 노드별, 데이터 타입별로 분류한다.
- 각 노드에는 관련 데이터가 포함된 버킷 세트가 있는 전용 폴더가 있다.
- Elasticsearch는 각 데이터 타입을 기반으로 버킷 세트(Elasticsearch용어로 index라고 함)를 생성한다.
- Index는 도큐먼트의 논리적 모음이다. 비즈니스 데이터를 보관하는 버킷이다.

Elasticsearch의 인덱스는 데이터베이스의 테이블과 같다

- 관계형 데이터베이스에서는 레코드를 보관할 테이블을 정의한다. 이 개념을 확장하면 Elasticsearch의 인덱스는 데이터베이스의 테이블과 동등하다.
- Elasticsearch를 사용하면 스키마 없는 인덱스를 생성할 수 있다.
- 인덱스는 도큐먼트를 샤드에 보관하는 논리적 컬렉션이다.
- 샤드는 아파치 루씬의 인스턴스를 실행하고 있다.

### 데이터 타입

데이터는 날짜, 숫자, 문자열, 부울, IP 주소, 위치 등 다양한 유형으로 제공된다.

Elasticsearch를 사용하면 풍부한 데이터 타입을 지원해 도큐먼트를 인덱싱할 수 있다.

매핑 

- 매핑이라는 프로세스는 JSON 데이터 타입을 적절한 Elasticsearch데이터 타입으로 변환한다.
- 매핑은 스키마 정의를 사용해 Elasticsearch에 데이터 필드 처리 방법을 알려준다.

데이터를 인덱싱하는 동안 Elasticsearch는 들어오는 데이터를 필드별로 분석한다.

매핑 정의를 기반으로 한 고급 알고리즘을 사용해 개별 필드를 분석한다.

풀텍스트 필드는 Elasticsearch와 같은 최신 검색엔진의 핵심인 텍스트 분석이라는 추가 프로세스를 거친다. 

텍스트 분석은 원시 데이터를 Elasticsearch가 수많은 쿼리를 지원하면서 효율적으로 데이터를 검색할 수 있는 형식으로 변환하는 중요한 단계다.

### 데이터 분석

텍스트 분석 단계에서는 텍스트로 표현된 데이터가 분석된다.

텍스트는 일련의 규칙을 사용해 단어로 분류된다.

분석 프로세스중에는 토큰화와 정규화라는 두 가지 프로세스가 발생한다.

```json
Peter Piper picked a peck of Pickled-peppers! // 토큰화되지 않은 문자열
[peter, piper, picked, a,peck,of,pickled,peppers] // 토큰화된 문자열 
```

토큰화

- 일련의 규칙에 따라 텍스트를 토큰으로 나누는 프로세스
- 위 synopsis 필드의 텍스트는 공백 구분 기호로 구분된 개별 단어로 구분된다.
- 이는 표준 토크나이저에 의해 수행된다.

정규화

- 토큰에 대한 추가 데이터를 생성해 풍부한 사용자 경험을 구축하는 데 도움을 준다.

### 데이터 출력

검색은 지정된 쿼리에 대해 일치하는 데이터를 가져오고, 분석은 데이터를 수집해 요약된 통계를 형성한다.

검색은 정확한 단어 대 단어 일치뿐만 아니라 어근, 동의어, 철자 오류 등도 찾는다.

### 도큐먼트

- document는 Elasticsearch가 저장을 위해 인덱싱한 정보의 기본 단위이다.
- 더 빠른 검색과 분석을 위해 각 도큐먼트의 개별 필드를 분석한다.
- Elasticsearch에서는 JSON 형식의 도큐먼트를 기대한다
- JSON은 최근 몇 년 동안 인기를 얻고 있는 사람이 읽을 수 있는 간단한 데이터 형식이다.
- Elasticsearch는 JSON파서를 사용해 인덱스에서 사용 가능한 매핑 규칙에 따라 데이터를 적절한 타입으로 역마샬링 한다.
- 각 인덱스에는 도큐먼트가 인덱싱되거나 검색 쿼리가 실행될 때 Elasticsearch가 적용하는 일련의 매핑 규칙이 있다.

`note`

- Elasticsearch의 데이터는 데이터가 다양한 형식으로 정규화되는 관계형 데이터베이스와 달리 빠른 검색을 지원하기 위해 역정규화된다.

**도큐먼트 작업 API**

단일 도큐먼트에 작업하는 것과 동시에 여러 도큐먼트에 대해 작업하는 두 가지 형태가 있다.

- 단일 도큐먼트 API
    - 개별 도큐먼트에 대한 작업을 하나씩 수행한다. 마찬가지로 이러한 API를 사용하면 도큐먼트를 가져오고, 인덱싱하고, 삭제하고, 업데이트할 수 있다.
- 다중 도큐먼트 API
    - 여러 도큐먼트를 동시에 작업한다. 이를 통해 단일 쿼리로 여러 도큐먼트를 삭제 및 업데이트하고, 대량으로 인덱싱하고, 소스 인덱스에서 대형 인덱스로 데이터를 다시 인덱싱 할 수 있다.

### 인덱스

Elasticsearch는 데이터 도큐먼트를 인덱스에 보관한다. 인덱스는 물리적 저장소가 아닌 논리적인 그룹이다. 

이는 샤드로 구성된다.

샤드는 데이터를 저장소에 들어오고 나가는 데 있어 뒤에서 일하는 역할을 하는 물리적 인스턴스다.

샤드는 데이터의 물리적 저장과 검색을 담당한다.

버전 7.x부터 생성된 모든 인덱스는 기본적으로 단일 샤드와 복제본으로 백업되도록 설정된다.

인덱스의 샤드와 복제본은 데이터 크기 요구 사항에 따라 구성하고 사용자 정의할 수 있다.

복제본의 수는 조정할 수 있지만, 활성화된 인덱스에서 샤드 수를 수정할 수는 없다.

샤드는 기본 샤드와 복제본 샤드로 나뉜다.

기본 샤드는 도큐먼트를 보관한다.

복제본 샤드는 이름에서 알 수 있듯이 기본 샤드의 복사본이다.

인덱스는 여러 도큐먼트를 보유할 수 있으므로 필요에 맞는 최적의 크기를 찾는 것이 좋다.

각 인덱스는 단일 노드에 존재하거나 클러스터의 여러 노드에 분산될 수 있다.

인덱스를 설정하기 전에 최적의 인덱스 크기 조정을 수행해야 한다. 크기는 현재 제공해야 할 데이터와 향후 예상 크기에 따라 달라진다.

모든 인덱스에는 mappings, settings, aliases같은 속성이 있다.

매핑은 스키마를 정의하는 프로세스인 반면, 설정을 통해 샤드와 복제본을 구성할 수 있다.

별칭은 단일 인덱스 또는 인덱스 집합에 부여되는 대체 이름이다.

샤드 수와 같은 속성은 인덱스가 작동 중일 때 변경할 수 없다.

- 샤드는 데이터를 보관하고 지원하는 데이터 구조를 생성하고, 쿼리를 관리하고, Elasticsearch에서 데이터를 분석하는 소프트웨어 구성 요소다.
- 인덱싱 과정에서 도큐먼트가 샤드로 이동한다.
- 샤드는 도큐먼트를 영속적인 파일시스템에 보관하기 위해 변경할 수 없는 파일 세그먼트를 생성한다.
- 샤드는 가용성과 장애 조치를 위해 클러스터 전체에 분산된다.
- 인덱스가 작동 중이면 샤드를 재배치 할 수 없다.

클러스터는 노드의 컬렉션이다.

노드는 Elasticsearch 서버의 인스턴스다.

`클러스터 상태`

- RED
    - 샤드가 아직 할당되지 않았으므로 일부 데이터를 쿼리에 사용할 수 없다.
    - 일반적으로 클러스터가 시작될 때 발생한다.
    - 이 기간 동안 샤드는 과도기적인 상태다. (transient)
- YELLOW
    - 샤드가 할당은 되었으나 복제본이 아직 할당되지 않은 상태다. 복제본을 호스팅하는 노드가 실패했거나 막 시작될 때 발생할 가능성이 높다.
- GREEN
    - 모든 샤드와 복제본이 할당되고 예상대로 작동하는 상태

- 새 노드가 활성화되면 샤드를 배포하는 것 외에도 복제본이 초기화된다.
- 각 샤드의 복제본이 생성되고, 데이터는 해당 샤드에서 이러한 복제본으로 복사된다.
- 복제본은 기본 샤드와 동일한 노드에 위치하지 않는다.

### 샤드 크기 결정

- 개별 샤드의 크기를 50GB 이하로 설정하는 것이 일반적이지만 샤드 크기는 최대 400GB에 달하는 경우도 있다.
- 깃허브의 인덱스는 각 120GB의 128개 샤드에 분산되어 있다.
- 노드의 힙 메모리를 염두에 두고 25GB~40GB사이의 샤드를 만드는 것이 좋다.
- 한 인덱스가 최대 500GB의 데이터를 보유할 수 있다는 것을 알고 있다면 이 데이터를 여러 노드에 분산된 10~20개의 샤드에 배포하는 것이 가장 좋다.
- 힙 메모리 또한 샤드 크기를 조정할 때 고려해야함.
    - 힙 메모리 기가바이트 당 최대 20개의 샤드를 호스팅하는 것이 좋다.
    - Elasticsearch는 기본적으로  1GB메모리로 실행되지만 config 디렉터리에 있는 jvm.options 파일을 편집해 변경 가능하다.
- 핵심은 샤드가 데이터를 저장하므로, 적절한 크기를 정하기 위해 초기 작업을 제대로 수행해야 한다.

`shard_number = hash(document_id) % number_of_priority_shards`

### 클러스터

클러스터는 스케일 업 또는 스케일 아웃 할 수 있다.

추가 노드가 부팅되면 [cluster.name](http://cluster.name) 속성이 동일한 한 기존 노드와 동일한 클러스터에 조인가능하다.

- 샤드의 관점에서 노드를 추가하면 생기는 이점
    - 일반적으로 데이터는 기존 인덱스에서 새 인덱스로 다시 인덱싱 가능하다.
    - 새 노드를 고려해 새 인덱스의 샤드 수를 구성할 수 있다.

### 노드 역할

모든 노드는 코디네이터부터 데이터 관리, 마스터가 되는 등 다양한 역할을 수행한다.

- master : 클러스터 관리가 주요 책임이다.
    - 상위 수준 작업에 관여한다. 마스터 노드가 실패하면 클러스터는 다른 노드 중 하나를 마스터로 선출한다.
- data : 도큐먼트 지속성 및 검색을 담당
    - 인덱싱, 검색, 삭제 등등 도큐먼트 관련 작업을 수행한다.
- ingest : 인덱싱 전 파이프라인 수집을 통한 데이터 변환 담당
    - 인덱싱 시작 전 변환 및 강화와 같은 수집 작업을 처리한다.
- machine learning : 머신러닝 작업 및 요청 처리
- transform : 변환 요청 처리
- coordination : 기본 역할, 유입되는 클라이언트 요청을 처리한다.
    - Elasticsearch에 요청이 들어오면 이러한 노드 중 하나가 요청을 선택하고 코디네이터의 역할을 맡아 처음부터 끝까지 관리한다.
    - 요청을 수락한 후 코디네이터는 다른 노드에 이 요청을 처리하도록 다시 요청한다.
    - 관리자 역할을 하는 것이다.
    - node.roles : [] 로 설정하면 코디네이터 역할만 진행한다. 그럼 로드밸런서 역할을 수행하고 요청을 처리하고, 결과 세트를 대조한다. 단순히 많은 노드를 코디네이터로 활성화 한다면 위험이 클 수 있다.

### 역인덱스

- Elasticsearch는 검색 단어 및 도큐먼트 연관에 대해 역인덱스를 참조한다.
- 역인덱스는 사전과 매우 유사한 구조이지만 단어와 해당 단어가 존재하는 도큐먼트 목록이 포함되어 있다.
- 검색 단계에서 도큐먼트를 조금 더 빨리 찾을 수 있는 열쇠이다.

### 요약

- Elasticsearch는 데이터를 가져와 인덱싱할 것으로 기대한다. 데이터 소스에는 단순 파일, 데이터베이스, 라이브 스트림, X 등이 포함될 수 있다.
- 인덱싱 프로세스에서 데이터는 엄격한 분석 단계를 거치며, 이 과정에서 역인덱스와 같은 고급 데이터 구조가 생성된다.
- 데이터는 검색 API를 통해 검색된다.
- 수신 데이터는 JSON 도큐먼트로 래핑돼야 한다.
- JSON 도큐먼트는 기본 데이터 보유 엔티티이므로 샤드와 복제본에 유지된다.
- 샤드와 복제본은 도큐먼트 유지, 검색 및 배포를 담당하는 아파치 루씬 인스턴스다.
- Elasticsearch 애플리케이션을 시작하면 단일 노드, 단일 클러스터 애플리케이션으로 부팅된다. 노드를 추가하면 클러스터가 확장돼 다중 노드 클러스터가 된다.